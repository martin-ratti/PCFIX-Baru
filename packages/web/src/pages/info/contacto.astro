---
export const prerender = false; // Disable prerender to fetch fresh config on request

import Layout from "../../layouts/Layout.astro";

let config = {
  direccionLocal: "Corrientes 1481, Arequito, Santa Fe",
  horariosLocal: "Lunes a Viernes: 9:00 - 18:00",
  telefono: "+54 346 451 3588",
  email: "pcfixbaru@gmail.com",
};

try {
  const apiUrl = import.meta.env.PUBLIC_API_URL || "http://localhost:3002/api";
  const response = await fetch(`${apiUrl}/config`);
  const result = await response.json();
  if (result.success && result.data) {
    const data = result.data;
    if (data.direccionLocal) config.direccionLocal = data.direccionLocal;
    if (data.horariosLocal) config.horariosLocal = data.horariosLocal;
  }
} catch (error) {
  // Silent fallback to default config if API is down or building
  console.warn("Could not fetch dynamic config, using defaults.");
}
---

<Layout title="PCFIX | Contacto">
  <main class="bg-gray-50 pb-12">
    {/* Banner Info Atención */}
    <div class="bg-white border-b border-gray-200 py-6 mb-8">
      <div class="container mx-auto px-6">
        <div
          class="flex flex-col md:flex-row justify-center gap-8 md:gap-24 text-center md:text-left"
        >
          <div class="flex items-center justify-center gap-4">
            <div class="bg-purple-100 p-3 rounded-full text-purple-600">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                class="w-6 h-6"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"
                ></path>
              </svg>
            </div>
            <div>
              <p
                class="text-xs text-gray-500 font-bold uppercase tracking-wider"
              >
                Atención Telefónica
              </p>
              <p class="text-lg font-black text-gray-800">{config.telefono}</p>
            </div>
          </div>

          <div class="flex items-center justify-center gap-4">
            <div class="bg-green-100 p-3 rounded-full text-green-600">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                class="w-6 h-6"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div>
              <p
                class="text-xs text-gray-500 font-bold uppercase tracking-wider"
              >
                Horarios de Local
              </p>
              <p class="text-lg font-black text-gray-800">
                {config.horariosLocal}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-6">
      <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-12">
        {/* Columna Izquierda: Mapa e Info */}
        <div class="space-y-8">
          <div class="space-y-2">
            <h1 class="text-3xl font-black text-secondary">
              Sucursal Arequito
            </h1>
            <p class="text-gray-500">
              Visítanos en nuestro local central o ponte en contacto.
            </p>
          </div>

          {/* Datos de Contacto Grid */}
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="flex items-start gap-3">
              <div class="text-blue-600 mt-1">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"
                  ></path>
                </svg>
              </div>
              <div>
                <h4 class="font-bold text-gray-800">Email</h4>
                <a
                  href={`mailto:${config.email}`}
                  class="text-gray-600 hover:text-primary transition-colors"
                  >{config.email}</a
                >
              </div>
            </div>

            <div class="flex items-start gap-3">
              <div class="text-green-500 mt-1">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 20.25c4.97 0 9-3.632 9-8.242 0-4.61-4.03-8.242-9-8.242-4.97 0-9 3.632-9 8.242 0 2.626 1.258 4.983 3.326 6.543a.75.75 0 01.274.62l-.089 1.498a.75.75 0 001.076.718l1.638-.636a.75.75 0 01.555 0c.66.216 1.36.34 2.12.34z"
                  ></path>
                </svg>
              </div>
              <div>
                <h4 class="font-bold text-gray-800">WhatsApp</h4>
                <a
                  href="https://wa.me/543464513588"
                  target="_blank"
                  class="text-gray-600 hover:text-primary transition-colors"
                  >{config.telefono}</a
                >
              </div>
            </div>

            <div class="flex items-start gap-3 md:col-span-2">
              <div class="text-red-500 mt-1">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z"
                  ></path>
                </svg>
              </div>
              <div>
                <h4 class="font-bold text-gray-800">Dirección</h4>
                <p class="text-gray-600">{config.direccionLocal}</p>
              </div>
            </div>
          </div>

          {/* Mapa */}
          <div
            class="rounded-xl overflow-hidden shadow-lg border border-gray-200 h-64 md:h-80 relative bg-gray-200"
          >
            <iframe
              src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3346.0402947190013!2d-61.4746!3d-33.1558!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x95c765790be90c79%3A0xe54238711e5f8f30!2sCorrientes%201481%2C%20S2183%20Arequito%2C%20Santa%20Fe!5e0!3m2!1sen!2sar!4v1701234567890!5m2!1sen!2sar"
              width="100%"
              height="100%"
              style="border:0;"
              allowfullscreen=""
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
              class="absolute inset-0 w-full h-full"></iframe>
          </div>
        </div>

        {/* Columna Derecha: Formulario (Bandeja de Entrada) */}
        <div
          class="bg-white p-8 rounded-xl shadow-lg border border-gray-100 h-fit"
        >
          <h2
            class="text-2xl font-black text-secondary mb-6 flex items-center gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="w-6 h-6 text-primary"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"
              ></path>
            </svg>
            Bandeja de Entrada
          </h2>

          <form id="contactForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label
                  class="block text-xs font-bold text-gray-500 uppercase mb-1"
                  >Nombre</label
                >
                <input
                  type="text"
                  name="nombre"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
                  placeholder="Tu nombre"
                  required
                />
              </div>
              <div>
                <label
                  class="block text-xs font-bold text-gray-500 uppercase mb-1"
                  >Apellido</label
                >
                <input
                  type="text"
                  name="apellido"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
                  placeholder="Tu apellido"
                />
              </div>
            </div>

            <div>
              <label
                class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Email</label
              >
              <input
                type="email"
                name="email"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
                placeholder="tu@email.com"
                required
              />
            </div>

            <div>
              <label
                class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Teléfono (Opcional)</label
              >
              <input
                type="tel"
                name="telefono"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
                placeholder="+54..."
              />
            </div>

            <div>
              <label
                class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Mensaje</label
              >
              <textarea
                name="mensaje"
                rows="4"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all resize-none"
                placeholder="¿En qué podemos ayudarte?"
                required></textarea>
            </div>

            <button
              type="submit"
              class="w-full bg-primary text-white font-bold py-3.5 rounded-xl hover:bg-opacity-90 transition-all shadow-lg hover:shadow-primary/30 active:scale-95 flex items-center justify-center gap-2"
            >
              <span>Enviar Consulta</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                class="w-5 h-5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"
                ></path>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <script>
    import { useToastStore } from "../../stores/toastStore";

    console.log("Contact script loaded");

    const form = document.getElementById("contactForm") as HTMLFormElement;

    if (form) {
      console.log("Contact form found");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("Form submitted");

        const submitBtn = form.querySelector(
          'button[type="submit"]',
        ) as HTMLButtonElement;

        if (!submitBtn) {
          console.error("Submit button not found");
          return;
        }

        const originalText = submitBtn.innerHTML;

        // Loading State
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
           <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Enviando...
        `;

        try {
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());

          // Debug payload
          console.log("Sending data:", data);

          const API_URL =
            import.meta.env.PUBLIC_API_URL || "http://localhost:3002/api";

          console.log("Target API:", API_URL);

          const res = await fetch(`${API_URL}/config/contact`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          console.log("Response status:", res.status);

          const result = await res.json();
          console.log("Response data:", result);

          if (result.success) {
            useToastStore
              .getState()
              .addToast(
                "Gracias por escribirnos. Te responderemos a la brevedad.",
                "success",
              );
            form.reset();
          } else {
            throw new Error(result.error || "Error al enviar el mensaje");
          }
        } catch (error: any) {
          console.error("Form error:", error);
          useToastStore
            .getState()
            .addToast(error.message || "Error al enviar el mensaje", "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });
    } else {
      console.error("Contact form element not found in DOM");
    }
  </script>
</Layout>
