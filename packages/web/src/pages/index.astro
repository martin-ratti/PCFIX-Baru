---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import Carousel from '../components/shared/Carousel.tsx';
import BrandCarousel from '../components/shared/BrandCarousel.tsx';
import HomeBanners from '../components/shared/HomeBanners.tsx';

// --- INTERFACES ---
interface ProductDB { id: number; nombre: string; descripcion: string; precio: string | number; precioOriginal: string | number | null; stock: number; foto: string | null; categoriaId: number; isFeatured: boolean; }
interface ProductCardProps { id: string; name: string; price: number; imageUrl: string; imageAlt: string; originalPrice?: number | null; stock: number; slug: string; description: string; }
interface Brand { id: number; nombre: string; logo: string | null; }
interface Banner { id: number; imagen: string; marca: Brand; }

// --- VARIABLES ---
let allProducts: ProductDB[] = [];
let featuredProducts: ProductCardProps[] = [];
let saleProducts: ProductCardProps[] = [];
let newArrivalsProducts: ProductCardProps[] = [];
let brands: Brand[] = [];
let banners: Banner[] = [];
let errorApi = false;

// --- CARGA DE DATOS OPTIMIZADA ---
try {
  const [featuredRes, saleRes, newRes, brandRes, bannerRes] = await Promise.all([
     fetch('http://localhost:3002/api/products?isFeatured=true&limit=8'),
     fetch('http://localhost:3002/api/products?hasDiscount=true&limit=8'),
     fetch('http://localhost:3002/api/products?limit=8'), // Novedades
     fetch('http://localhost:3002/api/brands'),
     fetch('http://localhost:3002/api/banners')
  ]);
  
  if (featuredRes.ok) { const r = await featuredRes.json(); if(r.success) featuredProducts = r.data.map(mapProductToCard); }
  if (saleRes.ok) { const r = await saleRes.json(); if(r.success) saleProducts = r.data.map(mapProductToCard); }
  if (newRes.ok) { const r = await newRes.json(); if(r.success) newArrivalsProducts = r.data.map(mapProductToCard); }
  if (brandRes.ok) { const r = await brandRes.json(); if(r.success) brands = r.data; }
  if (bannerRes.ok) { const r = await bannerRes.json(); if(r.success) banners = r.data; }
} catch (error) {
  console.error("Error cargando home:", error);
  errorApi = true;
}

function mapProductToCard(p: ProductDB): ProductCardProps {
  return {
    id: p.id.toString(), name: p.nombre, price: Number(p.precio), imageUrl: p.foto || 'https://placehold.co/600x600/111626/F2F2F2?text=Sin+Imagen',
    imageAlt: p.nombre, stock: p.stock, originalPrice: p.precioOriginal ? Number(p.precioOriginal) : null, slug: p.id.toString(), description: p.descripcion
  };
}
---

<Layout title="PCFIX | Tu Tienda de Tecnología">
  <Header />
  
  <main class="min-h-screen bg-light">
    
    <div class="container mx-auto px-6 pt-8">
      {/* BANNERS O HERO ESTATICO */}
      {banners.length > 0 ? (
        <HomeBanners banners={banners} client:load />
      ) : (
        <section class="relative bg-gradient-to-br from-secondary via-[#1a2342] to-primary text-white py-16 rounded-2xl overflow-hidden shadow-2xl mb-12">
          <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
            <div class="absolute -top-24 -right-24 w-96 h-96 bg-blue-500 rounded-full blur-3xl"></div>
            <div class="absolute bottom-0 left-0 w-64 h-64 bg-purple-500 rounded-full blur-3xl"></div>
          </div>
          <div class="container mx-auto px-6 relative z-10 text-center">
            <span class="inline-block py-1 px-3 rounded-full bg-white/10 border border-white/20 text-blue-200 text-xs font-bold tracking-wider mb-4 backdrop-blur-sm">NUEVA COLECCIÓN</span>
            <h1 class="text-4xl md:text-6xl font-black mb-6 leading-tight tracking-tight">Potencia tu Setup</h1>
            <div class="flex justify-center gap-4">
              <a href="/productos" class="bg-white text-primary px-8 py-3 rounded-full font-bold hover:bg-blue-50 transition-all transform hover:scale-105 shadow-lg">Ver Catálogo</a>
            </div>
          </div>
        </section>
      )}
    </div>

    {/* SECCIONES DE PRODUCTOS */}
    <div class="container mx-auto px-6 space-y-20 py-12">
      
      {featuredProducts.length > 0 && (
        <div class="space-y-4"><Carousel title="Productos Destacados" products={featuredProducts} client:visible /></div>
      )}
      {saleProducts.length > 0 && (
        <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100"><Carousel title="¡Ofertas Imperdibles!" products={saleProducts} client:visible /></div>
      )}
      {newArrivalsProducts.length > 0 && (
        <div class="space-y-4"><Carousel title="Recién Llegados" products={newArrivalsProducts} client:visible /></div>
      )}

      {/* CARGA / ERROR */}
      {!errorApi && allProducts.length === 0 && (
        <div class="text-center py-32 opacity-50"><div class="inline-block w-12 h-12 border-4 border-gray-300 border-t-primary rounded-full animate-spin mb-4"></div><p class="text-xl font-medium">Cargando el mejor hardware...</p></div>
      )}
      {errorApi && (
        <div class="text-center py-20 bg-red-50 rounded-xl border border-red-100 text-red-600"><p class="font-bold">Hubo un problema cargando los productos.</p><p class="text-sm">Por favor intenta recargar la página.</p></div>
      )}
    </div>
  </main>

  {/* MARCAS */}
  <div class="bg-white border-t border-gray-100 pt-12 pb-4">
    <BrandCarousel brands={brands} client:visible />
  </div>

  <Footer />
</Layout>