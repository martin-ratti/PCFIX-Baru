---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import BrandCarousel from "../components/ui/layout/BrandCarousel.tsx";
import HomeBanners from "../components/ui/layout/HomeBanners.tsx";

import FeaturesSection from "../components/ui/layout/FeaturesSection.astro";
import BestSellersCarousel from "../components/ui/layout/BestSellersCarousel.tsx";
import HomeCarousels from "../components/ui/layout/HomeCarousels.tsx";
import ContactInfo from "../components/ui/layout/ContactInfo.tsx";
import { API_URL } from "../utils/api";

import type { ProductDB, ProductCardProps, Brand } from "../types/product";
import type { Banner } from "../types/config";
import { mapProductDBToCardProps } from "../types/product";

let allProducts: ProductDB[] = [];
let featuredProducts: ProductCardProps[] = [];
let saleProducts: ProductCardProps[] = [];
let newArrivalsProducts: ProductCardProps[] = [];
let brands: Brand[] = [];
let banners: Banner[] = [];
let configHours = "";
let errorApi = false;

try {
  const [prodRes, brandRes, bannerRes, configRes] = await Promise.all([
    fetch(`${API_URL}/products?limit=30`),
    fetch(`${API_URL}/brands`),
    fetch(`${API_URL}/banners`),
    fetch(`${API_URL}/config`),
  ]);

  if (prodRes.ok) {
    const result = await prodRes.json();
    if (result.success) {
      allProducts = result.data;
      featuredProducts = allProducts
        .filter((p) => p.isFeatured)
        .slice(0, 8)
        .map(mapProductDBToCardProps);
      saleProducts = allProducts
        .filter((p) => p.precioOriginal)
        .slice(0, 8)
        .map(mapProductDBToCardProps);
      newArrivalsProducts = allProducts
        .slice(0, 8)
        .map(mapProductDBToCardProps);
    }
  } else {
    errorApi = true;
  }

  if (brandRes.ok) {
    const r = await brandRes.json();
    if (r.success) brands = r.data;
  }
  if (bannerRes.ok) {
    const r = await bannerRes.json();
    if (r.success) banners = r.data;
  }

  if (configRes.ok) {
    const json = await configRes.json();
    if (json.success && json.data?.horariosLocal) {
      configHours = json.data.horariosLocal;
    }
  }
} catch (error) {
  console.error("Error fetching data:", error);
  errorApi = true;
}
if (!configHours) configHours = "Lunes a Viernes: 9:00 - 18:00";
---

<Layout title="PCFIX | Tu Tienda de TecnologÃ­a">
  <main class="min-h-screen bg-light pb-12">
    <div class="container mx-auto px-6 pt-6">
      {
        banners.length > 0 ? (
          <HomeBanners banners={banners} client:load />
        ) : null
      }
    </div>

    <div class="container mx-auto px-6 py-8">
      <FeaturesSection />
    </div>

    <div class="container mx-auto px-6 py-8">
      <BestSellersCarousel client:visible />
    </div>

    <div class="container mx-auto px-6 space-y-16 py-8">
      <ContactInfo hours={configHours} client:visible />

      <div class="space-y-20">
        <HomeCarousels
          featuredProducts={featuredProducts}
          saleProducts={saleProducts}
          newArrivalsProducts={newArrivalsProducts}
          client:visible
        />
      </div>
      {
        !errorApi && allProducts.length === 0 && (
          <div class="text-center py-32 opacity-50">
            <p>Cargando...</p>
          </div>
        )
      }
    </div>
  </main>

  <div class="bg-white border-t border-gray-100 pt-12 pb-4">
    <BrandCarousel brands={brands} client:visible />
  </div>
</Layout>
