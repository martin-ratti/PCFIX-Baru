---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import Carousel, { type CarouselProduct } from '../components/shared/Carousel.tsx';

// Interfaz de la Base de Datos
interface ProductDB {
  id: number;
  nombre: string;
  descripcion: string;
  precio: string | number;
  precioOriginal: string | number | null;
  stock: number;
  foto: string | null;
  categoriaId: number;
}

// Usamos la interfaz exportada por el Carrusel para asegurar compatibilidad
let allProducts: ProductDB[] = [];
let featuredProducts: CarouselProduct[] = [];
let saleProducts: CarouselProduct[] = [];
let peripheralProducts: CarouselProduct[] = [];

try {
  const response = await fetch('http://localhost:3002/api/products');
  if (response.ok) {
    const result = await response.json();
    if (result.success) {
      allProducts = result.data;

      // 1. Destacados
      featuredProducts = allProducts.slice(0, 5).map(mapProductToCard);

      // 2. Ofertas
      const productsOnSale = allProducts.filter(p => 
        p.precioOriginal !== null && 
        Number(p.precioOriginal) > Number(p.precio)
      );
      saleProducts = productsOnSale.map(mapProductToCard);

      // 3. Novedades
      peripheralProducts = allProducts.slice(-5).map(mapProductToCard);
    }
  }
} catch (error) {
  console.error("Error cargando home:", error);
}

// Función de mapeo que devuelve exactamente lo que pide CarouselProduct
function mapProductToCard(p: ProductDB): CarouselProduct {
  return {
    id: p.id.toString(),
    name: p.nombre,
    price: Number(p.precio),
    imageUrl: p.foto || 'https://placehold.co/600x600/111626/F2F2F2?text=Sin+Imagen',
    imageAlt: p.nombre,
    stock: p.stock,
    // La clave: Convertir a Number o null explícitamente
    originalPrice: p.precioOriginal ? Number(p.precioOriginal) : null,
    slug: p.id.toString(),
    description: p.descripcion
  };
}

const customCarouselTitle = "Lo Más Nuevo";
---

<Layout title="PCFIX | Tu Tienda de Tecnología">
  <Header />
  <main class="container mx-auto px-6 py-8 min-h-screen">
    <section class="bg-accent rounded-lg p-8 mb-12 text-center shadow-lg transform hover:scale-[1.01] transition-transform duration-300">
      <h1 class="text-4xl font-black text-primary mb-4">Potencia tu Setup al Máximo</h1>
      <p class="text-lg text-secondary">Los mejores componentes y periféricos para tu PC.</p>
    </section>

    {featuredProducts.length > 0 && (
      <Carousel title="Productos Destacados" products={featuredProducts} client:visible />
    )}
        
    {saleProducts.length > 0 && (
      <Carousel title="¡Ofertas Imperdibles!" products={saleProducts} client:visible />
    )}
    
    {peripheralProducts.length > 0 && (
      <Carousel title={customCarouselTitle} products={peripheralProducts} client:visible />
    )}
  </main>
  <Footer />
</Layout>