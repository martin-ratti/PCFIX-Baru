---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import Carousel from "../components/ui/layout/Carousel.tsx";
import BrandCarousel from "../components/ui/layout/BrandCarousel.tsx";
import HomeBanners from "../components/ui/layout/HomeBanners.tsx";

import FeaturesSection from "../components/ui/layout/FeaturesSection.astro";
import CategoryGrid from "../components/ui/layout/CategoryGrid.astro";
import PromoBanner from "../components/ui/layout/PromoBanner.astro";

interface ProductDB {
  id: number;
  nombre: string;
  descripcion: string;
  precio: string | number;
  precioOriginal: string | number | null;
  stock: number;
  foto: string | null;
  categoriaId: number;
  isFeatured: boolean;
}
interface ProductCardProps {
  id: string;
  name: string;
  price: number;
  imageUrl: string;
  imageAlt: string;
  originalPrice?: number | null;
  stock: number;
  slug: string;
  description: string;
}
interface Brand {
  id: number;
  nombre: string;
  logo: string | null;
}
interface Banner {
  id: number;
  imagen: string;
  marca: Brand;
}

let allProducts: ProductDB[] = [];
let featuredProducts: ProductCardProps[] = [];
let saleProducts: ProductCardProps[] = [];
let newArrivalsProducts: ProductCardProps[] = [];
let brands: Brand[] = [];
let banners: Banner[] = [];
let configHours = "";
let errorApi = false;

// API URL
const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3002/api";

try {
  const [prodRes, brandRes, bannerRes, configRes] = await Promise.all([
    fetch(`${API_URL}/products?limit=30`),
    fetch(`${API_URL}/brands`),
    fetch(`${API_URL}/banners`),
    fetch(`${API_URL}/config`),
  ]);

  if (prodRes.ok) {
    const result = await prodRes.json();
    if (result.success) {
      allProducts = result.data;
      featuredProducts = allProducts
        .filter((p) => p.isFeatured)
        .slice(0, 8)
        .map(mapProductToCard);
      saleProducts = allProducts
        .filter((p) => p.precioOriginal)
        .slice(0, 8)
        .map(mapProductToCard);
      newArrivalsProducts = allProducts.slice(0, 8).map(mapProductToCard);
    }
  } else {
    errorApi = true;
  }

  if (brandRes.ok) {
    const r = await brandRes.json();
    if (r.success) brands = r.data;
  }
  if (bannerRes.ok) {
    const r = await bannerRes.json();
    if (r.success) banners = r.data;
  }

  // Parse Config
  if (configRes.ok) {
    const json = await configRes.json();
    if (json.success && json.data?.horariosLocal) {
      configHours = json.data.horariosLocal;
    }
  }
} catch (error) {
  console.error("Error fetching data:", error);
  errorApi = true;
}
if (!configHours) configHours = "Lunes a Viernes: 9:00 - 18:00"; // Fallback

function mapProductToCard(p: ProductDB): ProductCardProps {
  return {
    id: p.id.toString(),
    name: p.nombre,
    price: Number(p.precio),
    imageUrl: p.foto || "",
    imageAlt: p.nombre,
    stock: p.stock,
    originalPrice: p.precioOriginal ? Number(p.precioOriginal) : null,
    slug: p.id.toString(),
    description: p.descripcion,
  };
}
---

<Layout title="PCFIX | Tu Tienda de TecnologÃ­a">
  <main class="min-h-screen bg-light pb-12">
    <div class="container mx-auto px-6 pt-6">
      {
        banners.length > 0 ? (
          <HomeBanners banners={banners} client:load />
        ) : null
      }
    </div>

    <FeaturesSection />

    <CategoryGrid />

    <div class="container mx-auto px-6 space-y-16 py-8">
      {
        featuredProducts.length > 0 && (
          <div class="space-y-4">
            <Carousel
              title="ðŸ”¥ Destacados de la Semana"
              products={featuredProducts}
              client:visible
            />
          </div>
        )
      }

      <PromoBanner />

      <!-- SecciÃ³n AtenciÃ³n Compacta -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <div
          class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center divide-y md:divide-y-0 md:divide-x divide-gray-100"
        >
          <!-- TelÃ©fono -->
          <div
            class="flex items-center gap-4 px-4 justify-center md:justify-center"
          >
            <div
              class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-2xl shrink-0"
            >
              ðŸ“ž
            </div>
            <div>
              <p
                class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-0.5"
              >
                AtenciÃ³n TelefÃ³nica
              </p>
              <a
                href="tel:+543464513588"
                class="text-lg font-black text-gray-800 hover:text-primary transition-colors block leading-tight"
                >+54 346 451 3588</a
              >
            </div>
          </div>

          <!-- Horarios -->
          <div
            class="flex items-center gap-4 px-4 justify-center md:justify-center pt-4 md:pt-0"
          >
            <div
              class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center text-2xl shrink-0"
            >
              ðŸ•’
            </div>
            <div>
              <p
                class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-0.5"
              >
                Horarios de Local
              </p>
              <p class="text-lg font-bold text-gray-800 leading-tight">
                {configHours}
              </p>
            </div>
          </div>
        </div>
      </div>

      {
        saleProducts.length > 0 && (
          <div class="bg-white rounded-3xl p-5 shadow-sm border border-gray-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-500 to-pink-500" />
            <Carousel
              title="âš¡ Ofertas RelÃ¡mpago"
              products={saleProducts}
              client:visible
            />
          </div>
        )
      }

      {
        newArrivalsProducts.length > 0 && (
          <div class="space-y-4">
            <Carousel
              title="ðŸ†• ReciÃ©n Llegados"
              products={newArrivalsProducts}
              client:visible
            />
          </div>
        )
      }

      {
        !errorApi && allProducts.length === 0 && (
          <div class="text-center py-32 opacity-50">
            <p>Cargando...</p>
          </div>
        )
      }
    </div>
  </main>

  <div class="bg-white border-t border-gray-100 pt-12 pb-4">
    <BrandCarousel brands={brands} client:visible />
  </div>
</Layout>
