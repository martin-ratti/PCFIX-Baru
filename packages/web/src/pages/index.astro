---
// 1. ACTIVAR SSR
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import Carousel from '../components/shared/Carousel.tsx';

// Interfaz de la Base de Datos (Lo que viene de la API)
interface ProductDB {
  id: number;
  nombre: string;
  descripcion: string;
  precio: string | number;
  stock: number;
  foto: string | null;
  categoriaId: number;
}

// Interfaz Compatible con el Componente (Lo que espera el Carousel)
// Debe coincidir con la 'Product' de mock-data.ts
interface ProductCardProps {
  id: string;
  name: string;
  price: number;
  imageUrl: string;
  imageAlt: string;
  originalPrice?: number;
  stock: number;
  slug: string;
  description: string;
}

// Variables tipadas
let allProducts: ProductDB[] = [];
let featuredProducts: ProductCardProps[] = [];
let saleProducts: ProductCardProps[] = [];
let peripheralProducts: ProductCardProps[] = [];

// Fetch al Backend
try {
  const response = await fetch('http://localhost:3002/api/products');
  if (response.ok) {
    const result = await response.json();
    if (result.success) {
      allProducts = result.data;

      featuredProducts = allProducts.slice(0, 5).map(mapProductToCard);
      saleProducts = allProducts.slice(5, 10).map(mapProductToCard);
      peripheralProducts = allProducts.slice(-5).map(mapProductToCard);
    }
  }
} catch (error) {
  console.error("Error cargando productos del home:", error);
}

// Función mapeadora actualizada
function mapProductToCard(p: ProductDB): ProductCardProps {
  return {
    id: p.id.toString(),
    name: p.nombre,
    price: Number(p.precio),
    imageUrl: p.foto || 'https://placehold.co/600x600/111626/F2F2F2?text=Sin+Imagen',
    imageAlt: p.nombre,
    stock: p.stock,
    originalPrice: undefined,
    slug: p.id.toString(), // Usamos el ID como slug
    description: p.descripcion
  };
}

const customCarouselTitle = "Lo Más Nuevo";
---

<Layout title="PCFIX | Tu Tienda de Tecnología">
  <Header />

  <main class="container mx-auto px-6 py-8 min-h-screen">
    <section class="bg-accent rounded-lg p-8 mb-12 text-center shadow-lg transform hover:scale-[1.01] transition-transform duration-300">
      <h1 class="text-4xl font-black text-primary mb-4">Potencia tu Setup al Máximo</h1>
      <p class="text-lg text-secondary">Los mejores componentes y periféricos para tu PC.</p>
    </section>

    {featuredProducts.length > 0 ? (
      <>
        <Carousel title="Productos Destacados" products={featuredProducts} client:visible />
        
        {saleProducts.length > 0 && (
          <Carousel title="¡Ofertas Imperdibles!" products={saleProducts} client:visible />
        )}
        
        {peripheralProducts.length > 0 && (
          <Carousel title={customCarouselTitle} products={peripheralProducts} client:visible />
        )}
      </>
    ) : (
      <div class="text-center py-20">
        <p class="text-muted text-lg animate-pulse">Cargando catálogo...</p>
      </div>
    )}

  </main>

  <Footer />
</Layout>
