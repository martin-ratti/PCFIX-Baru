---
// 1. ACTIVAR SSR (Server Side Rendering)
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import AddToCart from '../../components/AddToCart.tsx';

interface Product {
  id: number;
  nombre: string;
  descripcion: string;
  precio: number | string;
  stock: number;
  foto: string | null;
  categoriaId: number;
  originalPrice?: number;
}

const { slug } = Astro.params;
let product: Product | null = null;

try {
  const response = await fetch(`http://localhost:3002/api/products/${slug}`);
  if (response.ok) {
    const result = await response.json();
    if (result.success) {
      product = result.data;
    }
  }
} catch (error) {
  console.error("Error fetching product:", error);
}

if (!product) {
  return new Response(null, {
    status: 404,
    statusText: 'No encontrado'
  });
}
---

<Layout title={`PCFIX | ${product.nombre}`}>
  <Header />

  <main class="container mx-auto px-6 py-12">
    <div class="bg-white p-8 rounded-lg shadow-lg">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-12 items-start">
        
        {/* Columna de la Imagen */}
        <div class="md:col-span-2 bg-white rounded-lg p-4 border border-gray-100 flex items-center justify-center">
          <img 
            src={product.foto || 'https://placehold.co/600x600/png?text=Sin+Imagen'} 
            alt={product.nombre}
            class="w-full h-auto object-contain max-h-[500px] rounded"
          />
        </div>

        {/* Columna de Información */}
        <div class="md:col-span-3">
          <h1 class="text-4xl font-black text-primary mb-4">{product.nombre}</h1>
          
          <div class="flex items-baseline gap-4 mb-4">
            <p class="text-4xl font-bold text-primary">${Number(product.precio).toLocaleString('es-AR')}</p>
          </div>

          <div class="mt-6 mb-8">
            <h2 class="text-xl font-bold text-secondary mb-2 border-b pb-2">Descripción</h2>
            <p class="text-muted leading-relaxed text-lg">{product.descripcion}</p>
          </div>

          <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
            <div class="flex justify-between items-center mb-4">
               <span class={`font-bold ${product.stock > 0 ? 'text-green-600' : 'text-red-500'}`}>
                 {product.stock > 0 ? 'Disponible' : 'Sin Stock'}
               </span>
               <span class="text-sm text-muted">Stock actual: {product.stock}</span>
            </div>

            <AddToCart 
              client:load 
              stock={product.stock} 
              product={{
                id: product.id.toString(),
                name: product.nombre,
                slug: product.id.toString(),
                price: Number(product.precio),
                imageUrl: product.foto || '',
                imageAlt: product.nombre,
                description: product.descripcion,
                stock: product.stock
              }}
            />
          </div>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>