---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ProductCard from '../../components/ProductCard'; 

// Definición de tipos para TypeScript
interface Category {
  id: number;
  nombre: string;
}

interface Product {
  id: number;
  nombre: string;
  descripcion: string;
  precio: string | number; // La API puede devolver string (Decimal) o number
  stock: number;
  foto: string | null;
  categoriaId: number;
  categoria: Category;
}

// Obtener el ID de la URL
const { id } = Astro.params;

let products: Product[] = [];
let categoryName = "Categoría";

// Fetch de datos al backend
try {
  // Asegúrate de que el puerto 3002 es el correcto donde corre tu API
  const response = await fetch(`http://localhost:3002/api/products?categoryId=${id}`);
  
  if (response.ok) {
    const result = await response.json();
    if (result.success) {
      products = result.data;
      
      // Intentamos obtener el nombre de la categoría del primer producto
      if (products.length > 0) {
        categoryName = products[0].categoria.nombre;
      }
    }
  }
} catch (error) {
  console.error("Error cargando productos de la categoría:", error);
}
---

<Layout title={`PCFIX | ${categoryName}`}>
  <Header />

  <main class="container mx-auto px-6 py-12 min-h-screen">
    <div class="mb-8 border-b pb-4">
      <h1 class="text-3xl font-black text-primary capitalize">{categoryName}</h1>
      <p class="text-muted mt-2">{products.length} productos encontrados</p>
    </div>

    {products.length > 0 ? (
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
        {products.map((product: Product) => (
          <ProductCard 
            client:visible
            product={{
              id: product.id.toString(),
              name: product.nombre,
              slug: product.id.toString(), // Usamos ID como slug temporalmente
              price: Number(product.precio),
              imageUrl: product.foto || 'https://placehold.co/600x600/png?text=Sin+Imagen',
              imageAlt: product.nombre,
              description: product.descripcion,
              stock: product.stock
            }} 
          />
        ))}
      </div>
    ) : (
      <div class="text-center py-20 bg-white rounded-lg shadow-sm border border-gray-100">
        <div class="mb-4 text-gray-300">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
        </div>
        <h2 class="text-xl font-bold text-gray-700 mb-2">No se encontraron productos</h2>
        <p class="text-gray-500 mb-6">Parece que aún no hay stock en esta categoría.</p>
        <a href="/" class="inline-flex items-center justify-center px-6 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-opacity-90 transition-colors">
          Volver al inicio
        </a>
      </div>
    )}
  </main>

  <Footer />
</Layout>