---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
// Rutas corregidas:
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import ProductCard from '../../components/products/ProductCard.tsx';

interface Category {
  id: number;
  nombre: string;
}

interface Product {
  id: number;
  nombre: string;
  descripcion: string;
  precio: string | number;
  stock: number;
  foto: string | null;
  categoriaId: number;
  categoria: Category;
}

const { id } = Astro.params;

let products: Product[] = [];
let categoryName = "Categoría";

try {
  const response = await fetch(`http://localhost:3002/api/products?categoryId=${id}`);
  
  if (response.ok) {
    const result = await response.json();
    if (result.success) {
      products = result.data;
      if (products.length > 0) {
        categoryName = products[0].categoria.nombre;
      }
    }
  }
} catch (error) {
  console.error("Error cargando productos:", error);
}
---

<Layout title={`PCFIX | ${categoryName}`}>
  <Header />

  <main class="container mx-auto px-6 py-12 min-h-screen">
    <div class="mb-8 border-b pb-4">
      <h1 class="text-3xl font-black text-primary capitalize">{categoryName}</h1>
      <p class="text-muted mt-2">{products.length} productos encontrados</p>
    </div>

    {products.length > 0 ? (
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
        {products.map((product: Product) => (
          <ProductCard 
            client:visible
            product={{
              id: product.id.toString(),
              name: product.nombre,
              slug: product.id.toString(),
              price: Number(product.precio),
              imageUrl: product.foto || 'https://placehold.co/600x600/png?text=Sin+Imagen',
              imageAlt: product.nombre,
              description: product.descripcion,
              stock: product.stock
            }} 
          />
        ))}
      </div>
    ) : (
      <div class="text-center py-20 bg-white rounded-lg shadow-sm border border-gray-100">
        <h2 class="text-xl font-bold text-gray-700 mb-2">No se encontraron productos</h2>
        <p class="text-gray-500 mb-6">Parece que aún no hay stock en esta categoría.</p>
        <a href="/" class="inline-flex items-center justify-center px-6 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-opacity-90 transition-colors">
          Volver al inicio
        </a>
      </div>
    )}
  </main>

  <Footer />
</Layout>