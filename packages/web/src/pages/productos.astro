---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import Header from '../components/ui/layout/Header.astro';
import Footer from '../components/ui/layout/Footer.astro';
import ProductCard from '../components/store/product/ProductCard.tsx';
import SortSelector from '../components/store/product/SortSelector.tsx';

interface ProductDB {
  id: number;
  nombre: string;
  descripcion: string;
  precio: string | number;
  precioOriginal: string | number | null;
  stock: number;
  foto: string | null;
  categoriaId: number;
  categoria?: { nombre: string };
}

interface ProductCardProps {
  id: string;
  name: string;
  price: number;
  imageUrl: string;
  imageAlt: string;
  originalPrice?: number | null;
  stock: number;
  slug: string;
  description: string;
  categoria?: { nombre: string };
}

const urlParams = Astro.url.searchParams;
const search = urlParams.get('search') || '';
const marcaId = urlParams.get('marcaId') || '';
const categoryId = urlParams.get('categoryId') || '';
const sort = urlParams.get('sort') || '';

let products: ProductCardProps[] = [];
let title = "Todos los Productos";

let categoryName = "";
let brandName = "";

try {
  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3002/api';
  
  const apiUrl = new URL(`${API_URL}/products`);
  if (search) apiUrl.searchParams.append('search', search);
  if (marcaId) apiUrl.searchParams.append('marcaId', marcaId);
  if (categoryId) apiUrl.searchParams.append('categoryId', categoryId);
  if (sort) apiUrl.searchParams.append('sort', sort);

  const response = await fetch(apiUrl.toString());
  if (response.ok) {
    const result = await response.json();
    if (result.success) {
      products = result.data.map((p: ProductDB) => ({
        id: p.id.toString(),
        name: p.nombre,
        price: Number(p.precio),
        originalPrice: p.precioOriginal ? Number(p.precioOriginal) : null,
        imageUrl: p.foto || 'https://placehold.co/600x600/png?text=Sin+Imagen',
        imageAlt: p.nombre,
        stock: p.stock,
        slug: p.id.toString(),
        description: p.descripcion,
        categoria: p.categoria
      }));
    }
  }

  if (categoryId) {
      try {
          const catResponse = await fetch(`${API_URL}/categories/${categoryId}`);
          if (catResponse.ok) {
              const catJson = await catResponse.json();
              if (catJson.success) {
                  categoryName = catJson.data.nombre;
              }
          }
      } catch (e) {
          console.error("Error fetching category name", e);
      }
  }

  if (search) title = `Resultados para: "${search}"`;
  else if (categoryName) title = categoryName; 
  else title = "Todos los Productos";

} catch (error) {
  console.error("Error cargando cat√°logo:", error);
}
---

<Layout title={`PCFIX | ${title}`}>
  <Header />

  <main class="container mx-auto px-6 py-12 min-h-screen">
    

    <div class="mb-8 border-b border-gray-200 pb-6 flex flex-col md:flex-row justify-between items-end gap-4">
      
      <div class="flex-1">
        <h1 class="text-3xl font-black text-secondary leading-tight">{title}</h1>
        

        {(search || marcaId || categoryId) ? (
           <div class="flex flex-wrap gap-2 mt-3 items-center">

             <a href="/productos" class="text-sm text-red-500 hover:text-red-700 font-bold flex items-center gap-1 bg-red-50 px-3 py-1 rounded-full transition-colors border border-red-100 hover:border-red-200">
               &times; Borrar filtros
             </a>
             

             {categoryId && (
                <span class="text-xs bg-blue-50 text-blue-700 px-3 py-1 rounded-full font-bold border border-blue-100 flex items-center gap-1">
                    {categoryName ? categoryName : `Categor√≠a: ${categoryId}`}
                </span>
             )}
             

             {marcaId && (
                <span class="text-xs bg-purple-50 text-purple-700 px-3 py-1 rounded-full font-bold border border-purple-100">
                    Marca: {marcaId}
                </span>
             )}
           </div>
        ) : (
           <p class="text-gray-500 mt-2 text-sm">Explora nuestro cat√°logo completo de hardware y servicios.</p>
        )}
      </div>
      

      <div class="flex flex-col sm:flex-row items-center gap-4 w-full md:w-auto">
          <span class="text-sm font-medium text-gray-400 whitespace-nowrap">
            {products.length} resultados
          </span>
          <SortSelector client:load />
      </div>
    </div>


    {products.length > 0 ? (
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 animate-fade-in">
        {products.map((product) => (
          <ProductCard client:visible product={product} />
        ))}
      </div>
    ) : (
      <div class="text-center py-20 bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center">
        <div class="text-6xl mb-4 opacity-50">üîç</div>
        <h2 class="text-xl font-bold text-secondary mb-2">No encontramos productos</h2>
        <p class="text-gray-500 mb-6 max-w-md mx-auto">Intenta ajustar tus filtros o busca con t√©rminos m√°s generales.</p>
        <a href="/productos" class="bg-primary text-white px-8 py-3 rounded-xl font-bold hover:bg-opacity-90 transition-all shadow-lg shadow-primary/20">
            Ver todo el cat√°logo
        </a>
      </div>
    )}
  </main>

  <Footer />
</Layout>