---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import ProductCard from '../components/products/ProductCard';

interface ProductDB {
  id: number;
  nombre: string;
  descripcion: string;
  precio: string | number;
  precioOriginal: string | number | null;
  stock: number;
  foto: string | null;
  categoriaId: number;
}

interface ProductCardProps {
  id: string;
  name: string;
  price: number;
  imageUrl: string;
  imageAlt: string;
  originalPrice?: number | null;
  stock: number;
  slug: string;
  description: string;
}

// 1. Capturar TODOS los par치metros de URL posibles
const urlParams = Astro.url.searchParams;
const search = urlParams.get('search') || '';
const marcaId = urlParams.get('marcaId') || '';
const categoryId = urlParams.get('categoryId') || ''; // 游녣 FALTABA ESTO

let products: ProductCardProps[] = [];
let title = "Todos los Productos";

try {
  const apiUrl = new URL('http://localhost:3002/api/products');
  
  // 2. Adjuntar filtros a la URL del backend
  if (search) {
    apiUrl.searchParams.append('search', search);
    title = `Resultados para: "${search}"`;
  }
  if (marcaId) {
    apiUrl.searchParams.append('marcaId', marcaId);
  }
  if (categoryId) {
    apiUrl.searchParams.append('categoryId', categoryId); // 游녣 ENVIAR AL BACKEND
  }

  const response = await fetch(apiUrl.toString());
  
  if (response.ok) {
    const result = await response.json();
    if (result.success) {
      products = result.data.map((p: ProductDB) => ({
        id: p.id.toString(),
        name: p.nombre,
        price: Number(p.precio),
        originalPrice: p.precioOriginal ? Number(p.precioOriginal) : null,
        imageUrl: p.foto || 'https://placehold.co/600x600/png?text=Sin+Imagen',
        imageAlt: p.nombre,
        stock: p.stock,
        slug: p.id.toString(),
        description: p.descripcion
      }));
    }
  }
} catch (error) {
  console.error("Error cargando cat치logo:", error);
}
---

<Layout title={`PCFIX | ${title}`}>
  <Header />

  <main class="container mx-auto px-6 py-12 min-h-screen">
    <div class="mb-8 border-b pb-4 flex justify-between items-end">
      <div>
        <h1 class="text-3xl font-black text-primary">{title}</h1>
        
        {/* Mostrar bot칩n de borrar filtros si hay alguno activo */}
        {(search || marcaId || categoryId) ? (
           <div class="flex gap-2 mt-2">
             <a href="/productos" class="text-sm text-red-500 hover:underline flex items-center gap-1">
               &times; Borrar filtros
             </a>
             
             {categoryId && <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">Categor칤a: {categoryId}</span>}
             {marcaId && <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">Marca: {marcaId}</span>}
           </div>
        ) : (
           <p class="text-muted mt-2">Explora nuestro cat치logo completo de hardware.</p>
        )}
      </div>
      
      <span class="text-sm font-medium bg-accent/20 text-primary px-3 py-1 rounded-full">
        {products.length} productos
      </span>
    </div>

    {products.length > 0 ? (
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
        {products.map((product) => (
          <ProductCard client:visible product={product} />
        ))}
      </div>
    ) : (
      <div class="text-center py-20 bg-white rounded-lg shadow-sm border border-gray-100">
        <div class="text-4xl mb-4">游댌</div>
        <h2 class="text-xl font-bold text-secondary mb-2">No encontramos productos</h2>
        <p class="text-gray-500 mb-6">Intenta con otra categor칤a o quita los filtros.</p>
        <a href="/productos" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-opacity-90 transition-colors">Ver todo</a>
      </div>
    )}
  </main>

  <Footer />
</Layout>