---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import ProductCatalog from "../../components/store/product/ProductCatalog.tsx";
import SortSelector from "../../components/store/product/SortSelector.tsx";
import { API_URL } from "../../utils/api";

import type {
  ProductDB,
  ProductCardProps,
  PaginationMeta,
} from "../../types/product";
import { mapProductDBToCardProps } from "../../types/product";

const urlParams = Astro.url.searchParams;
const search = urlParams.get("search") || "";
const marcaId = urlParams.get("marcaId") || "";
const categoryId = urlParams.get("categoryId") || "";
const sort = urlParams.get("sort") || "";

let products: ProductCardProps[] = [];
let meta: PaginationMeta = { total: 0, page: 1, lastPage: 1, limit: 12 };
let title = "Todos los Productos";

let categoryName = "";
let brandName = "";

try {
  

  const apiUrl = new URL(`${API_URL}/products`);
  apiUrl.searchParams.append("page", "1");
  apiUrl.searchParams.append("limit", "12"); 
  if (search) apiUrl.searchParams.append("search", search);
  if (marcaId) apiUrl.searchParams.append("marcaId", marcaId);
  if (categoryId) apiUrl.searchParams.append("categoryId", categoryId);
  if (sort) apiUrl.searchParams.append("order", sort);

  const response = await fetch(apiUrl.toString());
  if (response.ok) {
    const result = await response.json();
    if (result.success) {
      products = result.data.map((p: ProductDB) => mapProductDBToCardProps(p));
      meta = result.meta || meta;
    }
  }

  if (categoryId) {
    try {
      const catResponse = await fetch(`${API_URL}/categories/${categoryId}`);
      if (catResponse.ok) {
        const catJson = await catResponse.json();
        if (catJson.success) {
          categoryName = catJson.data.nombre;
        }
      }
    } catch (e) {
      console.error("Error fetching category name", e);
    }
  }

  if (marcaId) {
    try {
      const brandResponse = await fetch(`${API_URL}/brands/${marcaId}`);
      if (brandResponse.ok) {
        const brandJson = await brandResponse.json();
        if (brandJson.success) {
          brandName = brandJson.data.nombre;
        }
      }
    } catch (e) {
      console.error("Error fetching brand name", e);
    }
  }

  if (search) title = `Resultados para: "${search}"`;
  else if (categoryName) title = categoryName;
  else if (brandName) title = brandName;
  else title = "Todos los Productos";
} catch (error) {
  console.error("Error cargando catálogo:", error);
}
---

<Layout title={`PCFIX | ${title}`}>
  <main class="container mx-auto px-6 py-12 min-h-screen">
    <div
      class="mb-8 border-b border-gray-200 pb-6 flex flex-col md:flex-row justify-between items-end gap-4"
    >
      <div class="flex-1">
        <h1 class="text-3xl font-black text-secondary leading-tight">
          {title}
        </h1>

        {
          search || marcaId || categoryId ? (
            <div class="flex flex-wrap gap-2 mt-3 items-center">
              <a
                href="/tienda/productos"
                class="text-sm text-red-500 hover:text-red-700 font-bold flex items-center gap-1 bg-red-50 px-3 py-1 rounded-full transition-colors border border-red-100 hover:border-red-200"
              >
                &times; Borrar filtros
              </a>

              {categoryId && (
                <span class="text-xs bg-blue-50 text-blue-700 px-3 py-1 rounded-full font-bold border border-blue-100 flex items-center gap-1">
                  {categoryName ? categoryName : `Categoría: ${categoryId}`}
                </span>
              )}

              {marcaId && (
                <span class="text-xs bg-purple-50 text-purple-700 px-3 py-1 rounded-full font-bold border border-purple-100">
                  {brandName ? brandName : `Marca: ${marcaId}`}
                </span>
              )}
            </div>
          ) : (
            <p class="text-gray-500 mt-2 text-sm">
              Explora nuestro catálogo completo de hardware y servicios.
            </p>
          )
        }
      </div>

      <div
        class="flex flex-col sm:flex-row items-center gap-4 w-full md:w-auto"
      >
        <span class="text-sm font-medium text-gray-400 whitespace-nowrap">
          {meta.total} productos
        </span>
        <SortSelector client:load />
      </div>
    </div>

    <ProductCatalog
      client:load
      initialProducts={products}
      initialMeta={meta}
      search={search}
      categoryId={categoryId}
      marcaId={marcaId}
      sort={sort}
    />
  </main>
</Layout>
