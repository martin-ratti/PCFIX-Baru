---
import { Image } from "astro:assets";
import logo from "../../../assets/logo.png";

import CartIcon from "../../store/cart/CartIcon.tsx";
import UserMenu from "../../ui/layout/UserMenu.tsx";
import AdminLinks from "../../admin/core/AdminLinks.tsx";
import CategoryDropdown from "../../ui/layout/CategoryDropdown.tsx";
import PublicLinks from "../../ui/layout/PublicLinks.tsx";
import LiveSearch from "../../ui/forms/LiveSearch.tsx";
import ErrorBoundary from "../../ui/feedback/ErrorBoundary.tsx";
import MobileMenu from "../../ui/layout/MobileMenu.tsx";

let categories = [];
try {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 1000);
  const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3002/api";
  const response = await fetch(`${API_URL}/categories`, {
    signal: controller.signal,
  });
  clearTimeout(timeoutId);
  if (response.ok) {
    const json = await response.json();
    if (json.success) categories = json.data;
  }
} catch (e) {
  if (import.meta.env.DEV) console.warn("⚠️ API Categorías offline.");
  categories = [];
}
---

<header
  class="w-full bg-accent shadow-md sticky top-0 z-50 transition-all duration-300 ease-in-out border-b border-white/5"
  id="main-header"
>
  <nav
    class="container mx-auto px-6 py-3 flex justify-between items-center gap-6 transition-all duration-300"
    id="header-nav"
  >
    <div class="shrink-0 flex items-center gap-6">
      <a href="/" class="block hover:opacity-90 transition-opacity">
        <Image
          src={logo}
          alt="PCFIX Logo"
          width={150}
          class="object-contain transition-all duration-300 origin-left h-20 w-auto"
          id="header-logo"
        />
      </a>
      <div class="h-6 w-px bg-white/10 mx-2 hidden md:block"></div>
      <div class="hidden md:block">
        <CategoryDropdown initialCategories={categories} client:load />
      </div>
    </div>

    <div class="flex-1 flex justify-center w-full max-w-5xl">
      <div class="w-full flex items-center gap-4">
        <ErrorBoundary client:load name="LiveSearch">
          <LiveSearch client:load />
        </ErrorBoundary>
        <AdminLinks client:load />
      </div>
    </div>

    <div class="flex items-center gap-6 shrink-0">
      <div class="hidden md:block">
        <PublicLinks client:load />
      </div>
      <div class="h-6 w-px bg-white/10 mx-2 hidden md:block"></div>
      <div class="flex items-center gap-4">
        <CartIcon client:load />
        <div class="hidden md:block">
          <UserMenu client:load />
        </div>
        <MobileMenu client:load />
      </div>
    </div>
  </nav>

  <style>
    header.is-scrolled {
      @apply shadow-xl bg-accent/95 backdrop-blur-md;
    }

    header.is-scrolled #header-nav {
      @apply py-2;
    }

    header.is-scrolled #header-logo {
      @apply h-14;
    }
  </style>

  <script>
    // Store reference to cleanup function
    let scrollCleanup: (() => void) | null = null;

    document.addEventListener("astro:page-load", () => {
      const header = document.getElementById("main-header");

      // Clean up previous scroll listener if exists
      if (scrollCleanup) {
        scrollCleanup();
      }

      let ticking = false;

      const handleScroll = () => {
        if (!header) return;

        const scrollY = window.scrollY;

        if (!ticking) {
          window.requestAnimationFrame(() => {
            // Buffer/Histéresis para evitar "popping" justo en el límite
            // Si baja: activa a los 20px
            // Si sube: desactiva a los 10px
            // Esto evita que parpadée si te quedas en el medio (e.g. 15px)
            if (scrollY > 20) {
              if (!header.classList.contains("is-scrolled"))
                header.classList.add("is-scrolled");
            } else if (scrollY < 10) {
              if (header.classList.contains("is-scrolled"))
                header.classList.remove("is-scrolled");
            }
            ticking = false;
          });
          ticking = true;
        }
      };

      window.addEventListener("scroll", handleScroll, { passive: true });

      // Store cleanup function for next navigation
      scrollCleanup = () => {
        window.removeEventListener("scroll", handleScroll);
      };

      // Initial check
      handleScroll();
    });

    // Also cleanup on before-swap for View Transitions
    document.addEventListener("astro:before-swap", () => {
      if (scrollCleanup) {
        scrollCleanup();
        scrollCleanup = null;
      }
    });
  </script>
</header>
